{"name":"R pure","tagline":"Workflow for flood frequency analysis under uncertainty (still work in progress!)","body":"PURE (R package)\r\n================\r\n\r\nWorkflow for flood frequency analysis under uncertainty (work in progress!).\r\n\r\nProject: PURE (Probability, Uncertainty and Risk in the Environment) - RACER consortium (Flood strand)\r\n\r\nCheck out: NERC-PURE programme at http://www.nerc.ac.uk/research/programmes/pure/.\r\n\r\nRequirements:\r\nsudo apt-get install libudunits2-dev\r\ninstall.packages(\"hydroTSM\")\r\n\r\n\r\n#### Basics\r\nInstall and load packages\r\n```R\r\n# Install dependent packages from CRAN:\r\nx <- c(\"zoo\", \"chron\", \"xts\", \"manipulate\", \"rgdal\", \"tgp\",\r\n       \"sp\", \"gstat\", \"grid\", \"hydroTSM\", \"Hmisc\", \"raster\", \"reshape2\", \r\n       \"ggplot2\", \"qualV\", \"lhs\", \"MASS\")\r\ninstall.packages(x)\r\nlapply(x, require, character.only=T); rm(x)\r\n\r\n# Install dpendent package from R-Forge:\r\ninstall.packages(\"fuse\", repos=\"http://R-Forge.R-project.org\")\r\nlibrary(fuse)\r\n\r\n# Install dependent gists and packages from github:\r\nlibrary(devtools)\r\ninstall_github(\"r_rnrfa\", username = \"cvitolo\", subdir = \"rnrfa\")\r\nlibrary(rnrfa)\r\n\r\n# Install pure package\r\ninstall_github(\"r_pure\", username = \"cvitolo\", subdir = \"pure\")\r\nlibrary(pure)\r\n```\r\n\r\nMake zoo objects for your time series: \r\n\r\n* Q is the streamflow time series. \r\n* E is the list of potential evapotranspiration time series. If E is unknown, wheather variables can be used to calculate the potential evapotranspiration (see section PET).\r\n* P is the list of rainfall time series. If there are 3 raingauges in the catchment (e.g. P1, P2 and P3), the object P is: \r\n    + P <- list(P1,P2,P3)\r\n\r\nAn example is given below:\r\n```R\r\n# Load sample time series (this contains 3 objects: P, E and Q)\r\ndata(P1)\r\ndata(P2)\r\ndata(P3)\r\ndata(Q)\r\ndata(weather)\r\n```\r\n\r\n### Pre-processing\r\nBelow are a series of utility functions for time series pre-processing, divided in 4 categories: \r\n\r\n* Report\r\n* Correct\r\n* Aggregate\r\n* Model specific preparation\r\n\r\n##### Report\r\nReport problems with time series using the function `ScanTS()`.\r\nAs an example you can use the example dataset provided with this package.\r\n\r\n```R\r\n# Report\r\nScanTS( P1, verbose = TRUE  )\r\nScanTS( P2, verbose = FALSE )\r\nScanTS( P3, verbose = FALSE )\r\nScanTS( Q,  verbose = FALSE )\r\nScanTS( weather$TD,  verbose = FALSE, returnNegInfo = FALSE )\r\nScanTS( weather$TW,  verbose = FALSE, returnNegInfo = FALSE )\r\nScanTS( weather$NR,  verbose = FALSE, returnNegInfo = FALSE )\r\nScanTS( weather$WS,  verbose = FALSE )\r\n```\r\n\r\n##### Correct, aggregate and prepare for modelling with FUSE\r\nOften time series are recorded at non-regular time steps. You can shift your records to align them with a regular grid using the function `Irr2Reg()`.\r\n```R\r\n# From irregular to regular frequency time step:\r\nP1Reg <- Irr2Reg( P1 )\r\nP2Reg <- Irr2Reg( P2 )\r\nP3Reg <- Irr2Reg( P3 )\r\nQReg  <- Irr2Reg( Q )\r\nTW    <- Irr2Reg( weather$TW )\r\nTD    <- Irr2Reg( weather$TD )\r\nNR    <- Irr2Reg( weather$NR )\r\nWS    <- Irr2Reg( weather$WS )\r\n\r\n# test the effect of Irr2Reg()\r\nplot(P1[40:45])\r\nlines(P1Reg[40:45],col=\"red\")\r\n```\r\n\r\nChange any unrealistic values to NA (e.g. negative P and Q) using the function `CorrectNeg()`. \r\n\r\n```R\r\nP1NoNeg <- CorrectNeg( P1Reg )\r\n\r\n# test the effect of CorrectNeg()\r\nplot(P1Reg)\r\nlines(P1NoNeg,col=\"red\")\r\n```\r\n\r\n# Common temporal resolution\r\nFind coarser temporal resolution (in seconds!) amongst a list of time series and aggregate all of them to the same temporal resolution\r\n```R\r\nmyList <- list(\"P1\" = P1NoNeg, \"P2\" = P2Reg, \"P3\" = P3Reg, \r\n               \"Q\" = QReg, \"TW\" = TW, \"TD\" = TD, \"NR\" = NR, \"WS\" = WS)\r\nx <- CommonTemporalResolution(myList)\r\n\r\n# use \"mean\" for rates, \"sum\" for volumes\r\nP1 <- period.apply(myList$P1, endpoints(myList$P1, \"seconds\", x), mean)\r\nP2 <- period.apply(myList$P2, endpoints(myList$P2, \"seconds\", x), mean)\r\nP3 <- period.apply(myList$P3, endpoints(myList$P3, \"seconds\", x), mean)\r\nTW <- period.apply(myList$TW, endpoints(myList$TW, \"seconds\", x), mean)\r\nTD <- period.apply(myList$TD, endpoints(myList$TD, \"seconds\", x), mean)\r\nNR <- period.apply(myList$NR, endpoints(myList$NR, \"seconds\", x), mean)\r\nWS <- period.apply(myList$WS, endpoints(myList$WS, \"seconds\", x), mean)\r\nQ  <- period.apply(myList$Q,  endpoints(myList$Q,  \"seconds\", x), mean)\r\n```\r\n\r\nDerive new variables, e.g. potential evapotranspiration from weather variables\r\n```R\r\nE <- pet(stationElevation=0,TD,TW,NR,WS)\r\n```\r\n\r\nSelect periods with simultaneous recordings\r\n```R\r\ntsList <- list(\"P1\" = P1, \"P2\" = P2, \"P3\" = P3, \"E\" = E, \"Q\" = Q)\r\nnewList <- ExtractOverlappingPeriod(tsList)\r\n\r\n# test\r\nnewList[73:77,1]\r\nwindow(P1Reg, start=index(newList[72,1]), end=index(newList[77,1]))\r\n```\r\n\r\nAggregate in space, e.g. areal averaging using spatial interpolation methods\r\n```R\r\ntsList <- data.frame(index(newList),\"P1\"=newList$P1,\r\n                     \"P2\"=newList$P2,\"P2\"=newList$P3)\r\n                     \r\nP <- ArealAveraging(tsList,areas=c(0.3,0.6,0.1),\r\n                    interpolationMethod =\"Thiessen\")\r\n```\r\n\r\nCheck if there are gaps in the records and infill\r\n```R\r\nany(is.na(P)) # FALSE\r\n\r\nany(is.na(newList$E)) # This returns TRUE, therefore we will infill the missing values\r\nEnomissing <- na.approx(newList$E)\r\n\r\nany(is.na(newList$Q)) # This returns TRUE, therefore we will infill the missing values\r\nQnomissing <- na.approx(newList$Q)\r\n```\r\n\r\nIf necessary, convert units to mm/day:\r\n```R\r\nP <- P*24 # from mm/h to mm/day\r\nE <- Enomissing*24 # from mm/h to mm/day\r\n\r\nArea <- 10.55 # Km2\r\nQ <- Qnomissing*86.4/Area\r\n```\r\n\r\nMerge P, E and Q in 1 time series object\r\n```R\r\nDATA <- merge(P,E,Q)\r\n```   \r\n\r\n### Rainfall-Runoff modelling using FUSE\r\nAs an example, we could combine 50 parameter sets and 4 model structures to generate 200 model simulations.\r\n\r\nSample 50 parameter sets for FUSE, using LHS method\r\n```R\r\nlibrary(fuse)\r\ndata(DATA)\r\n\r\nset.seed(123)\r\nNumberOfRuns <- 10    \r\nparameters <- GeneratePsetsFUSE(NumberOfRuns)\r\n```\r\n\r\nChoose a list of models to take into account\r\n```R\r\ndata(modlist)\r\nparentModels <- c(60,230,342,426) # those are the parent models \r\nModelList <- modlist[which(modlist$mid %in% parentModels),]\r\nrow.names(ModelList) <- NULL\r\n```\r\n\r\nDefine the list of Model Performance Indices (MPIs)\r\n```R\r\nlibrary(tiger)\r\nlibrary(qualV)\r\n\r\nLAGTIME = function(x) lagtime(x$Qo,x$Qs)    \r\nMAE     = function(x) mean(x$Qs - x$Qo, na.rm = TRUE)            \r\nNSHF    = function(x) 1 - EF(x$Qo,x$Qs)           \r\nNSLF    = function(x) 1 - EF( log(x$Qo) , log(x$Qs) )           \r\nRR      = function(x) sum(x$Qs) /sum(x$Po)\r\n\r\nMPIs <- list(\"LAGTIME\"=LAGTIME,\"MAE\"=MAE,\"NSHF\"=NSHF,\"NSLF\"=NSLF,\"RR\"=RR)\r\n```\r\n\r\nRun simulations\r\n```R\r\noutputFolder <- \"~\"\r\ndeltim <- 1/24 # or dt/60/60/24\r\nwarmup <- round(dim(DATA)[1]/10,0)\r\n\r\n# It is recommended to run simulations on HPC facilities. \r\n# However small batches can be run locally using the function MCsimulations()\r\nMCsimulations(DATA,deltim,warmup,parameters,ModelList,outputFolder,MPIs)\r\n```\r\n\r\n### Find the best configuration(s) amongst those simulated\r\nFor this task it is necessary to install another experimental package called AMCA:\r\n\r\n```R\r\n# Install pure package\r\ninstall_github(\"r_amca\", username = \"cvitolo\", subdir = \"amca\")\r\nlibrary(amca)\r\n```\r\n\r\nRun the algorithm:\r\n```R\r\nresults <- amca(DATA,ModelList,warmup,parameters,outputFolder)\r\n```\r\n\r\nThe best configuration is stored in\r\n```R\r\nresults$RETable\r\n```\r\n\r\n# Leave your feedback\r\nI would greatly appreciate if you could leave your feedbacks via email (cvitolodev@gmail.com).\r\n","google":"UA-44379190-4","note":"Don't delete this file! It's used internally to help with page regeneration."}